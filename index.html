<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bi-Weekly Timesheet – 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    .sheet-container {
      max-width: 900px; margin: 0 auto; background:#fff;
      padding: 20px 24px 30px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
    }
    .logo-row { text-align:center; margin-bottom: 8px; }
    .logo-row img { max-height: 70px; }
    h1 { text-align:center; margin: 6px 0 12px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 14px; }
    th { background: #e8e8e8; text-align: left; }

    .no-border td { border: none; padding: 4px; }

    input, select {
      width: 100%; box-sizing: border-box;
      border: 1px solid #ccc; border-radius: 3px;
      padding: 4px; font-size: 13px;
    }
    input[readonly] { background:#f7f7f7; }

    .total-row td { font-weight: bold; background:#fafafa; }

    .buttons { margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end; }
    button {
      padding: 8px 16px; border-radius: 6px; border: none;
      cursor: pointer; font-size: 14px;
    }
    .btn-print { background:#777; color:#fff; }
    .btn-submit { background:#0073e6; color:#fff; }

    /* Login UI */
    .login-box { text-align:center; }
    .login-inputs { max-width: 380px; margin: 0 auto; text-align:left; }
    .login-inputs label { display:block; margin-top: 10px; font-size: 13px; }
    .login-buttons { margin-top: 14px; display:flex; gap:12px; justify-content:center; flex-wrap: wrap; }
    .login-message { margin-top: 10px; min-height: 18px; font-size: 13px; color:#b00020; }
    .user-email { margin-top: 8px; font-size: 13px; color:#333; }

    @media print {
      .buttons { display:none; }
      body { background:#fff; }
      .sheet-container { box-shadow:none; }
      #loginContainer { display:none !important; }
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginContainer" class="sheet-container">
  <div class="login-box">
    <h2>Timesheet Login</h2>
    <p>Access is restricted to approved users.</p>

    <div class="login-inputs">
      <label for="loginEmail">Email</label>
      <input type="email" id="loginEmail" placeholder="you@example.com" />

      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" placeholder="Create or enter password" />
    </div>

    <div class="login-buttons">
      <button id="signUpBtn" type="button">Sign up</button>
      <button id="loginBtn" type="button">Log in</button>
      <button id="resetBtn" type="button">Forgot password</button>
      <button id="signOutBtn" type="button" style="display:none;">Sign out</button>
    </div>

    <div id="loginMessage" class="login-message"></div>
    <div id="loggedInInfo" class="user-email"></div>

    <div style="margin-top:10px; font-size:12px; color:#666; text-align:left; max-width:380px; margin-left:auto; margin-right:auto;">
      <strong>Note:</strong> This password is for the timesheet system (Firebase), not your Gmail password.
    </div>
  </div>
</div>

<!-- TIMESHEET -->
<div id="timesheetContainer" class="sheet-container" style="display:none;">
  <div class="logo-row">
    <img src="logo.png" alt="360 Logo">
  </div>

  <h1>Bi-Weekly Timesheet – 2026</h1>

  <table class="no-border">
    <tr>
      <td style="width:18%;"><strong>Period</strong></td>
      <td style="width:32%;">
        <select id="weekPeriod"></select>
      </td>
      <td style="width:18%;"><strong>Send To Email</strong></td>
      <td style="width:32%;">
        <input type="email" id="recipientEmail" placeholder="supervisor@example.com" />
      </td>
    </tr>
    <tr>
      <td><strong>School Name</strong></td>
      <td><input type="text" id="schoolName" /></td>
      <td><strong>Supervisor Email</strong></td>
      <td><input type="email" id="supervisorEmail" /></td>
    </tr>
    <tr>
      <td><strong>Employee Name</strong></td>
      <td><input type="text" id="employeeName" /></td>
      <td><strong>Title</strong></td>
      <td><input type="text" id="employeeTitle" /></td>
    </tr>
    <tr>
      <td><strong>Supervisor Name</strong></td>
      <td><input type="text" id="supervisorName" /></td>
      <td></td><td></td>
    </tr>
  </table>

  <table>
    <thead>
      <tr>
        <th style="width:40%;">Date (Weekday)</th>
        <th style="width:15%;">Time In</th>
        <th style="width:15%;">Time Out</th>
        <th style="width:15%;">Lunch (minutes)</th>
        <th style="width:15%;">Hours</th>
      </tr>
    </thead>
    <tbody id="timesheetBody"></tbody>
    <tfoot>
      <tr class="total-row">
        <td>Total</td><td></td><td></td><td></td>
        <td><span id="totalHours">0.00</span></td>
      </tr>
    </tfoot>
  </table>

  <div class="buttons">
    <button class="btn-print" type="button" onclick="window.print()">Print</button>
    <button id="submitBtn" class="btn-submit" type="button" onclick="submitTimesheet()">Submit</button>
  </div>

  <div style="margin-top:10px; font-size:12px; color:#666;">
    Submission will be saved & emailed by the server. Unauthorized users cannot submit.
  </div>
</div>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

<script>
/* ===================== CONFIG ===================== */

// Your Apps Script Web App URL (POST only)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyMuC8UVXly9jEzLUP-en-ZlSpCxYiWxJTSNopLWzcMyARtTBV3-7F0GyXJZYf0rww/exec";

// Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDn4kef3XjyJiDgXnD8ZLRO_-q3c7467pA",
  authDomain: "timesheet360-92220.firebaseapp.com",
  projectId: "timesheet360-92220",
  storageBucket: "timesheet360-92220.firebasestorage.app",
  messagingSenderId: "526532359738",
  appId: "1:526532359738:web:881ddbe435d0ea5942e703"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

let loggedInEmail = "";

/* ===================== UI HELPERS ===================== */

function setMsg(text, ok=false) {
  const el = document.getElementById("loginMessage");
  el.style.color = ok ? "#006400" : "#b00020";
  el.textContent = text || "";
}

function showLogin() {
  document.getElementById("loginContainer").style.display = "block";
  document.getElementById("timesheetContainer").style.display = "none";
  document.getElementById("signOutBtn").style.display = "none";
  document.getElementById("loggedInInfo").textContent = "";
}

function showTimesheet(email) {
  document.getElementById("loginContainer").style.display = "none";
  document.getElementById("timesheetContainer").style.display = "block";
  document.getElementById("signOutBtn").style.display = "inline-block";
  document.getElementById("loggedInInfo").textContent = "Logged in as: " + email;
}

/* ===================== AUTH (NO FETCH HERE) ===================== */

document.getElementById("signUpBtn").addEventListener("click", async () => {
  try {
    setMsg("");
    const email = (document.getElementById("loginEmail").value || "").trim().toLowerCase();
    const pass  = document.getElementById("loginPassword").value || "";

    if (!email || !pass) return setMsg("Please enter both email and password.");
    if (pass.length < 6) return setMsg("Password must be at least 6 characters.");

    await auth.createUserWithEmailAndPassword(email, pass);
    setMsg("Account created. You are now logged in.", true);
  } catch (err) {
    console.error("Sign up error:", err);
    setMsg(err?.message || "Sign up failed.");
  }
});

document.getElementById("loginBtn").addEventListener("click", async () => {
  try {
    setMsg("");
    const email = (document.getElementById("loginEmail").value || "").trim().toLowerCase();
    const pass  = document.getElementById("loginPassword").value || "";

    if (!email || !pass) return setMsg("Please enter both email and password.");

    await auth.signInWithEmailAndPassword(email, pass);
  } catch (err) {
    console.error("Login error:", err);
    setMsg(err?.message || "Login failed.");
  }
});

document.getElementById("resetBtn").addEventListener("click", async () => {
  try {
    setMsg("");
    const email = (document.getElementById("loginEmail").value || "").trim().toLowerCase();
    if (!email) return setMsg("Enter your email first, then click Forgot password.");

    await auth.sendPasswordResetEmail(email);
    setMsg("Password reset email sent. Check your inbox.", true);
  } catch (err) {
    console.error("Reset error:", err);
    setMsg(err?.message || "Password reset failed.");
  }
});

document.getElementById("signOutBtn").addEventListener("click", async () => {
  await auth.signOut();
});

auth.onAuthStateChanged(user => {
  if (!user || !user.email) {
    loggedInEmail = "";
    showLogin();
    return;
  }
  loggedInEmail = user.email;
  setMsg("");
  showTimesheet(loggedInEmail);
  buildPeriods();
  populateDays();
});

/* ===================== TIMESHEET ===================== */

const YEAR = 2026;
const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

function ordinalSuffix(n) {
  const j = n % 10, k = n % 100;
  if (j === 1 && k !== 11) return "st";
  if (j === 2 && k !== 12) return "nd";
  if (j === 3 && k !== 13) return "rd";
  return "th";
}

function buildPeriods() {
  const sel = document.getElementById("weekPeriod");
  if (sel.options.length > 0) return;

  monthNames.forEach((m, idx) => {
    sel.add(new Option(`${m} 1st Half`, `${idx}-1`));
    sel.add(new Option(`${m} 2nd Half`, `${idx}-2`));
  });

  sel.addEventListener("change", populateDays);
}

function createRow(dateStr) {
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>${dateStr}</td>
    <td><input type="time" class="time-in"></td>
    <td><input type="time" class="time-out"></td>
    <td><input type="number" class="lunch" min="0" step="5" placeholder="0"></td>
    <td><input class="row-total" readonly></td>
  `;

  tr.querySelector(".time-in").addEventListener("change", updateTotals);
  tr.querySelector(".time-out").addEventListener("change", updateTotals);
  tr.querySelector(".lunch").addEventListener("input", updateTotals);

  return tr;
}

function populateDays() {
  const selVal = document.getElementById("weekPeriod").value;
  const [monthIndex, half] = selVal.split("-").map(Number);

  const daysInMonth = new Date(YEAR, monthIndex + 1, 0).getDate();
  const startDay = (half === 1) ? 1 : 16;
  const endDay   = (half === 1) ? 15 : daysInMonth;

  const tbody = document.getElementById("timesheetBody");
  tbody.innerHTML = "";

  for (let d = startDay; d <= endDay; d++) {
    const dt = new Date(YEAR, monthIndex, d);
    const dow = dt.getDay();
    if (dow === 0 || dow === 6) continue;

    const label = `${dayNames[dow]}, ${monthNames[monthIndex]} ${d}${ordinalSuffix(d)}, ${YEAR}`;
    tbody.appendChild(createRow(label));
  }

  updateTotals();
}

function updateTotals() {
  let totalAll = 0;

  document.querySelectorAll("#timesheetBody tr").forEach(row => {
    const tIn = row.querySelector(".time-in").value;
    const tOut = row.querySelector(".time-out").value;
    const lunchMinutes = parseFloat(row.querySelector(".lunch").value) || 0;
    const totalEl = row.querySelector(".row-total");

    if (tIn && tOut) {
      const [inH, inM] = tIn.split(":").map(Number);
      const [outH, outM] = tOut.split(":").map(Number);
      let minutes = (outH * 60 + outM) - (inH * 60 + inM) - lunchMinutes;
      if (minutes < 0) minutes = 0;

      const hours = minutes / 60;
      totalEl.value = hours.toFixed(2);
      totalAll += hours;
    } else {
      totalEl.value = "";
    }
  });

  document.getElementById("totalHours").textContent = totalAll.toFixed(2);
}

/* ===================== SUBMIT (CONFIRMED SUCCESS ONLY) ===================== */

function setSubmitBusy(isBusy) {
  const btn = document.getElementById("submitBtn");
  if (!btn) return;
  btn.disabled = isBusy;
  btn.style.opacity = isBusy ? "0.7" : "1";
  btn.textContent = isBusy ? "Submitting..." : "Submit";
}

async function submitTimesheet() {
  updateTotals();

  const period = document.getElementById("weekPeriod").selectedOptions[0]?.text || "";
  const recipientEmail = (document.getElementById("recipientEmail").value || "").trim();
  const schoolName = document.getElementById("schoolName").value || "";
  const supervisorEmail = document.getElementById("supervisorEmail").value || "";
  const employeeName = document.getElementById("employeeName").value || "";
  const employeeTitle = document.getElementById("employeeTitle").value || "";
  const supervisorName = document.getElementById("supervisorName").value || "";
  const totalHours = document.getElementById("totalHours").textContent;

  if (!recipientEmail) {
    alert("Please enter the email address to send this timesheet to.");
    return;
  }
  if (!loggedInEmail) {
    alert("You are not logged in. Please log in again.");
    return;
  }

  const rows = [];
  document.querySelectorAll("#timesheetBody tr").forEach(row => {
    rows.push({
      date: row.cells[0].textContent,
      timeIn: row.querySelector(".time-in").value,
      timeOut: row.querySelector(".time-out").value,
      lunchMinutes: row.querySelector(".lunch").value || "0",
      hours: row.querySelector(".row-total").value || "0"
    });
  });

  // Send as FormData to avoid CORS preflight issues.
  // Nested data (rows) is sent as a JSON string.
  const formData = new FormData();
  formData.append("period", period);
  formData.append("schoolName", schoolName);
  formData.append("supervisorEmail", supervisorEmail);
  formData.append("employeeName", employeeName);
  formData.append("employeeTitle", employeeTitle);
  formData.append("supervisorName", supervisorName);
  formData.append("recipientEmail", recipientEmail);
  formData.append("totalHours", totalHours);
  formData.append("userEmail", loggedInEmail);
  formData.append("rows", JSON.stringify(rows));

  setSubmitBusy(true);

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: formData,
      redirect: "follow"
    });

    const raw = await res.text(); // could be OK or JSON
    let ok = false;

    // If server returns JSON {status:"ok"}
    try {
      const parsed = JSON.parse(raw);
      ok = (parsed && String(parsed.status).toLowerCase() === "ok");
    } catch {
      // If server returns plain text OK
      ok = String(raw || "").trim().toLowerCase() === "ok";
    }

    if (!res.ok || !ok) {
      console.error("Server did not confirm success:", { httpStatus: res.status, raw });
      alert("Submission failed (server did not confirm). Please contact HR.");
      return;
    }

    alert("Submitted! It will be saved to the Google Sheet and emailed by the server.");
  } catch (err) {
    console.error("Submit error:", err);
    alert("Submission failed. Please contact HR.");
  } finally {
    setSubmitBusy(false);
  }
}
</script>

</body>
</html>
